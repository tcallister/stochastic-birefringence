<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gwBackground &mdash; stochastic-birefringence  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            stochastic-birefringence
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../making-figures.html">Figure generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-the-analyses.html">Running the analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">stochastic-birefringence</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">gwBackground</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gwBackground</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">jax.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">Planck18</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="n">codeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<div class="viewcode-block" id="v">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.v">[docs]</a>
<span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="n">Mtot</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function computing the PN expansion parameter (pi*M*f)**(1/3) and returning a tuple of its first three powers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Mtot : float</span>
<span class="sd">        Total binary mass in units of solar masses</span>
<span class="sd">    f : float or np.array</span>
<span class="sd">        Frequency or frequencies at which to evaluate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pn_params : np.array</span>
<span class="sd">        Array containing the first, second, and third powers of the PN expansion parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="o">*</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="o">*</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="o">*</span><span class="n">f</span><span class="p">)])</span></div>


<div class="viewcode-block" id="dEdf">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.dEdf">[docs]</a>
<span class="k">def</span> <span class="nf">dEdf</span><span class="p">(</span><span class="n">Mtot</span><span class="p">,</span><span class="n">freqs</span><span class="p">,</span><span class="n">eta</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">PN</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to compute the energy spectrum radiated by a CBC</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Mtot : float</span>
<span class="sd">        Total mass in units of Msun</span>
<span class="sd">    freqs : np.array</span>
<span class="sd">        Array of frequencies at which we want to evaluate dEdf</span>
<span class="sd">    eta : float</span>
<span class="sd">        Reduced mass ratio. Defaults to 0.25 (equal mass)</span>
<span class="sd">    PN: bool</span>
<span class="sd">        If True, will include PN corrections to radiated energy spectrum (Default True) </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dEdf : np.array</span>
<span class="sd">        Energy spectrum in units of J/Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Fix spin magnitudes to zero for convenience</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Initialize energy density</span>
    <span class="n">dEdf_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PN</span><span class="p">:</span>

        <span class="c1"># Waveform model from Ajith+ 2011 (10.1103/PhysRevLett.106.241101)</span>
        
        <span class="c1"># PN corrections to break frequencies bounding different waveform regimes</span>
        <span class="c1"># See Eq. 2 and Table 1</span>
        <span class="n">eta_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eta</span><span class="p">,</span><span class="n">eta</span><span class="o">*</span><span class="n">eta</span><span class="p">,</span><span class="n">eta</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">eta</span><span class="p">])</span>
        <span class="n">chi_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">chi</span><span class="p">,</span><span class="n">chi</span><span class="o">*</span><span class="n">chi</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fM_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.6437</span><span class="p">,</span><span class="mf">0.827</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2706</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.05822</span><span class="p">,</span><span class="o">-</span><span class="mf">3.935</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="o">-</span><span class="mf">7.092</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]])</span>
        <span class="n">fR_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.1469</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1228</span><span class="p">,</span><span class="o">-</span><span class="mf">0.02609</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.0249</span><span class="p">,</span><span class="mf">0.1701</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">2.325</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]])</span>
        <span class="n">fC_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.1331</span><span class="p">,</span><span class="o">-</span><span class="mf">0.08172</span><span class="p">,</span><span class="mf">0.1451</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.2714</span><span class="p">,</span><span class="mf">0.1279</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">4.922</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]])</span>
        <span class="n">sig_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.4098</span><span class="p">,</span><span class="o">-</span><span class="mf">0.03523</span><span class="p">,</span><span class="mf">0.1008</span><span class="p">],[</span><span class="mf">1.829</span><span class="p">,</span><span class="o">-</span><span class="mf">0.02017</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="o">-</span><span class="mf">2.87</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]])</span>

        <span class="c1"># Define frequencies</span>
        <span class="c1"># See Eq. 2 and Table 1</span>
        <span class="n">fMerge</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">4.455</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.217</span> <span class="o">+</span> <span class="mf">3.521</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.26</span> <span class="o">+</span> <span class="n">eta_arr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fM_corrections</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chi_arr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">fRing</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.315</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">eta_arr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fR_corrections</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chi_arr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">fCut</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3236</span> <span class="o">+</span> <span class="mf">0.04894</span><span class="o">*</span><span class="n">chi</span> <span class="o">+</span> <span class="mf">0.01346</span><span class="o">*</span><span class="n">chi</span><span class="o">*</span><span class="n">chi</span> <span class="o">+</span> <span class="n">eta_arr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fC_corrections</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chi_arr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.45</span> <span class="o">-</span> <span class="mf">0.1575</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.75</span> <span class="o">+</span> <span class="n">eta_arr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sig_corrections</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chi_arr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>

        <span class="c1"># Identify piecewise components</span>
        <span class="n">inspiral</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">&lt;</span><span class="n">fMerge</span>
        <span class="n">merger</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">&gt;=</span><span class="n">fMerge</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">freqs</span><span class="o">&lt;</span><span class="n">fRing</span><span class="p">)</span>
        <span class="n">ringdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">&gt;=</span><span class="n">fRing</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">freqs</span><span class="o">&lt;</span><span class="n">fCut</span><span class="p">)</span>

        <span class="c1"># Define PN amplitude corrections</span>
        <span class="c1"># See Eq. 1 and following text</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">323.</span><span class="o">/</span><span class="mf">224.</span> <span class="o">+</span> <span class="mf">451.</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mf">168.</span><span class="p">,</span> <span class="p">(</span><span class="mf">27.</span><span class="o">/</span><span class="mf">8.</span><span class="o">-</span><span class="mf">11.</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">chi</span><span class="p">])</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.4547</span><span class="o">*</span><span class="n">chi</span><span class="o">-</span><span class="mf">1.8897</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8153</span><span class="o">*</span><span class="n">chi</span><span class="o">+</span><span class="mf">1.6557</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="n">Mtot</span><span class="p">,</span><span class="n">freqs</span><span class="p">)</span>

        <span class="c1"># Compute multiplicative scale factors to enforce continuity of dEdf across boundaries</span>
        <span class="c1"># Note that w_m and w_r are the ratios (inspiral/merger) and (merger/ringdown), as defined below</span>
        <span class="n">v_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="n">Mtot</span><span class="p">,</span><span class="n">fMerge</span><span class="p">)</span>
        <span class="n">v_r</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="n">Mtot</span><span class="p">,</span><span class="n">fRing</span><span class="p">)</span>
        <span class="n">w_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">fMerge</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_m</span><span class="p">),</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">fMerge</span><span class="p">,</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">eps</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_m</span><span class="p">),</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">fMerge</span><span class="p">)</span>
        <span class="n">w_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">fRing</span><span class="p">,</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">eps</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_r</span><span class="p">),</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">fMerge</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">fRing</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">fMerge</span><span class="o">*</span><span class="n">fRing</span><span class="o">**</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)))</span>

        <span class="c1"># Energy spectrum</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">inspiral</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">inspiral</span><span class="p">],</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">alpha</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vs</span><span class="p">[:,</span><span class="n">inspiral</span><span class="p">]),</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">merger</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">merger</span><span class="p">],</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">eps</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vs</span><span class="p">[:,</span><span class="n">merger</span><span class="p">]),</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">fMerge</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">freqs</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span><span class="o">-</span><span class="n">fRing</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">/</span><span class="mf">2.</span><span class="p">))))</span><span class="o">/</span><span class="p">(</span><span class="n">fMerge</span><span class="o">*</span><span class="n">fRing</span><span class="o">**</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Waveform model from Ajith+ 2008 (10.1103/PhysRevD.77.104017)</span>
        <span class="c1"># Define IMR parameters</span>
        <span class="c1"># See Eq. 4.19 and Table 1</span>
        <span class="n">fMerge</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.29740</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">0.044810</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.095560</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">fRing</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.59411</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">0.089794</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.19111</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">fCut</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.84845</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">0.12828</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.27299</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.50801</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">0.077515</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.022369</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">MsunToSec</span><span class="p">)</span>

        <span class="c1"># Identify piecewise components</span>
        <span class="n">inspiral</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">&lt;</span><span class="n">fMerge</span>
        <span class="n">merger</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">&gt;=</span><span class="n">fMerge</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">freqs</span><span class="o">&lt;</span><span class="n">fRing</span><span class="p">)</span>
        <span class="n">ringdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">&gt;=</span><span class="n">fRing</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">freqs</span><span class="o">&lt;</span><span class="n">fCut</span><span class="p">)</span>

        <span class="c1"># Energy spectrum</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">inspiral</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">inspiral</span><span class="p">],</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">merger</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">merger</span><span class="p">],</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">fMerge</span>
        <span class="n">dEdf_spectrum</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">freqs</span><span class="p">[</span><span class="n">ringdown</span><span class="p">]</span><span class="o">-</span><span class="n">fRing</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">/</span><span class="mf">2.</span><span class="p">))))</span><span class="o">/</span><span class="p">(</span><span class="n">fMerge</span><span class="o">*</span><span class="n">fRing</span><span class="o">**</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>

    <span class="c1"># Normalization</span>
    <span class="n">Mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="mf">3.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">Mtot</span><span class="o">*</span><span class="n">Msun</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">G</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Mc</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span>

    <span class="k">return</span> <span class="n">amp</span><span class="o">*</span><span class="n">dEdf_spectrum</span></div>


<div class="viewcode-block" id="OmegaGW">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.OmegaGW">[docs]</a>
<span class="k">class</span> <span class="nc">OmegaGW</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class used to compute the stochastic energy density of a CBC population.</span>
<span class="sd">    To make the evaluation as fast as possible, we&#39;ll implement integration over redshift and mass distribution</span>
<span class="sd">    via array multiplication. Different mass distributions are imposed by specifying probability weights in mass space.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref_mMin</span><span class="p">,</span><span class="n">ref_mMax</span><span class="p">,</span><span class="n">ref_zs</span><span class="p">,</span><span class="n">fmax</span><span class="p">,</span><span class="n">Mtots</span><span class="o">=</span><span class="p">[],</span><span class="n">qs</span><span class="o">=</span><span class="p">[],</span><span class="n">gridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">65</span><span class="p">)):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes class by setting up a grid of masses and mass ratios, and evaluating the radiated energy spectrum dE/df</span>
<span class="sd">        across this grid. This allows us to precompute dE/df, only evaluating it *once*. When computing a *population-averaged*</span>
<span class="sd">        energy spectrum, we will take a weighted sum across this grid. Weights are imposed by redefining `self.probs`, implemented</span>
<span class="sd">        in child classes via the `setProbs()` function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref_mMin: float</span>
<span class="sd">            Minimum component mass to consider in mass grid</span>
<span class="sd">        ref_mMax: float</span>
<span class="sd">            Maximum component mass to consider in mass grid</span>
<span class="sd">        ref_zs: np.array</span>
<span class="sd">            Redshift array across which we will integrate to compute Omega(f)</span>
<span class="sd">        fMax: float</span>
<span class="sd">            Maximum detector-frame frequency to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save reference grid of redshifts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span> <span class="o">=</span> <span class="n">ref_zs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comoving_distances</span> <span class="o">=</span> <span class="n">Planck18</span><span class="o">.</span><span class="n">comoving_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Gpc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Initialize grid of masses over which we&#39;ll compute dE/df</span>
        <span class="c1"># In particular, we&#39;ll grid log-uniformly in total mass and uniformly in mass ratio q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_mMin</span> <span class="o">=</span> <span class="n">ref_mMin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_mMax</span> <span class="o">=</span> <span class="n">ref_mMax</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mtots</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_Mtots</span> <span class="o">=</span> <span class="n">Mtots</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_Mtots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_mMin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_mMax</span><span class="p">),</span><span class="n">gridSize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span> <span class="o">=</span> <span class="n">qs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qMin</span> <span class="o">=</span> <span class="n">ref_mMin</span><span class="o">/</span><span class="n">ref_mMax</span> <span class="c1">#max(0.05,ref_mMin/ref_mMax)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">qMin</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">gridSize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mtots_2d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_Mtots</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span><span class="p">)</span>

        <span class="c1"># Compute the component masses and reduced mass ratios at each grid point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtots_2d</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2s_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_2d</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtots_2d</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_etas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_qs</span><span class="p">)</span>

        <span class="c1"># Array of frequencies at which dE/df will be evaluated for each point in our mass grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span><span class="mi">250</span><span class="p">)</span>

        <span class="c1"># Remember that we need to consider binaries placed across a *range* of redshifts.</span>
        <span class="c1"># For a given system mass, we need to know not just dE/df(f), but the *redshifted* spectrum dE/df(f*(1+z))</span>
        <span class="c1"># at both difference frequencies f and merger redshifts z</span>

        <span class="c1"># Set up a 2D array of source-frame frequencies f(1+z)</span>
        <span class="c1"># i.e. self.ref_redshiftedFreqs[i,j] corresponds to self.ref_freqs[j]*(1.+self.ref_zs[i])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_redshiftedFreqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">])</span>

        <span class="c1"># Now evaluate the energy spectrum at each of these source-frame frequencies, for every point in our mass grid</span>
        <span class="c1"># self.ref_energySpectra[i,j,k,:] is the energy contribution from a CBC with reduced mass ratio self.ref_etas[i],</span>
        <span class="c1"># total mass self.ref_Mtots[j], and at redshift self.ref_zs[k].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_energySpectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">dEdf</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_redshiftedFreqs</span><span class="p">,</span><span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_Mtots</span><span class="p">]</span> <span class="k">for</span> <span class="n">eta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_etas</span><span class="p">])</span>

        <span class="c1"># Initialize weights for mass grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtots_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span>

<div class="viewcode-block" id="OmegaGW.amplification">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.OmegaGW.amplification">[docs]</a>
    <span class="k">def</span> <span class="nf">amplification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kappa_d</span><span class="p">,</span><span class="n">kappa_z</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to compute exponential factor by which GW energies are birefringently amplified</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kappa_d : float</span>
<span class="sd">            Coefficient determining degree of amplitude birefringence with comoving distance</span>
<span class="sd">        kappa_z : float</span>
<span class="sd">            Coefficient determining degree of amplitude birefringence with redshift</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cosh_amplification_factor : np.array</span>
<span class="sd">            2D array of cosh amplification factors modifying the energy radiated at detector-frame frequencies `self.ref_freqs` from sources at `self.ref_zs`; used to compute Stokes I background</span>
<span class="sd">        sinh_amplification_factor : np.array</span>
<span class="sd">            2D array of sinh amplification factors modifying the energy radiated at detector-frame frequencies `self.ref_freqs` from sources at `self.ref_zs`; used to compute Stokes V background</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute argument of amplification exponentials</span>
        <span class="n">amplification_factor</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">kappa_d</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">comoving_distances</span><span class="o">+</span><span class="n">kappa_z</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">)[</span><span class="n">jnp</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="p">[:,</span><span class="n">jnp</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>

        <span class="c1"># Get cosh and sinh of this factor, for Stokes I and V respectively</span>
        <span class="n">cosh_amplification_factor</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span><span class="n">amplification_factor</span><span class="p">)</span>
        <span class="n">sinh_amplification_factor</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">amplification_factor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cosh_amplification_factor</span><span class="p">,</span><span class="n">sinh_amplification_factor</span></div>


<div class="viewcode-block" id="OmegaGW.eval">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.OmegaGW.eval">[docs]</a>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">R0</span><span class="p">,</span><span class="n">dRdV</span><span class="p">,</span><span class="n">targetFreqs</span><span class="p">,</span><span class="n">kappa_d</span><span class="p">,</span><span class="n">kappa_z</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a prescription for the local merger rate and its evolution over redshift, compute Omega(f)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        R0 : float</span>
<span class="sd">            Local merger rate density in units Gpc^{-3} yr^{-1}</span>
<span class="sd">        dRdV : np.array</span>
<span class="sd">            Arbitrarily normalized merger rate density as a function of redshift. Should be defined at the same redshifts specified in `self.ref_zs`</span>
<span class="sd">        targetFreqs : np.array</span>
<span class="sd">            Array of frequencies at which we want Omega(f). Must be above 10 and below the `fmax` used to initialize the object</span>
<span class="sd">        kappa_d : float</span>
<span class="sd">            Coefficient governing birefringence with respect to comoving distance</span>
<span class="sd">        kappa_z : float</span>
<span class="sd">            Coefficient governing birefringence with respect to redshift</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        final_Omg_I_spectrum : np.array</span>
<span class="sd">            Array containing Stokes I energy density spectrum</span>
<span class="sd">        final_Omg_V_spectrum : np.array</span>
<span class="sd">            Array containing Stokes V energy density spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert to number per Mpc^3 per sec and normalize merger rate density</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">R0</span><span class="o">/</span><span class="mf">1e9</span><span class="o">/</span><span class="n">year</span>
        <span class="n">dRdV_norm</span> <span class="o">=</span> <span class="n">R0</span><span class="o">*</span><span class="n">dRdV</span><span class="o">/</span><span class="n">dRdV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute weighted average of energy-density spectrum, integrated over total mass and mass ratio space</span>
        <span class="c1"># The result is a 2D array, with dedf[i,j] the population-averaged energy contributed at detector-frame</span>
        <span class="c1"># frequency i by binaries at redshift j</span>
        <span class="n">dedf</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_energySpectra</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dedf_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_energySpectra</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Birefringently amplify</span>
        <span class="n">cosh_amp</span><span class="p">,</span><span class="n">sinh_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplification</span><span class="p">(</span><span class="n">kappa_d</span><span class="p">,</span><span class="n">kappa_z</span><span class="p">)</span>
        <span class="n">dedf_I</span> <span class="o">=</span> <span class="n">dedf</span><span class="o">*</span><span class="n">cosh_amp</span>
        <span class="n">dedf_V</span> <span class="o">=</span> <span class="n">dedf</span><span class="o">*</span><span class="n">sinh_amp</span>
        
        <span class="c1"># Redshift integrand</span>
        <span class="n">R_invE</span> <span class="o">=</span> <span class="n">dRdV_norm</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">OmgM</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">)</span><span class="o">**</span><span class="mf">3.</span><span class="o">+</span><span class="n">OmgL</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">)</span>

        <span class="c1"># Integrate over redshifts via a dot product between dedf and the redshift-dependent R_invE</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Omg_I_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="o">/</span><span class="n">rhoC</span><span class="o">/</span><span class="n">H0</span><span class="p">)</span><span class="o">*</span><span class="n">dedf_I</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_invE</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span>
        <span class="n">Omg_V_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="o">/</span><span class="n">rhoC</span><span class="o">/</span><span class="n">H0</span><span class="p">)</span><span class="o">*</span><span class="n">dedf_V</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R_invE</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span>

        <span class="c1"># Interpolate onto desired frequencies and return</span>
        <span class="n">final_Omg_I_spectrum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">targetFreqs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="p">,</span><span class="n">Omg_I_spectrum</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">final_Omg_V_spectrum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">targetFreqs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_freqs</span><span class="p">,</span><span class="n">Omg_V_spectrum</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_Omg_I_spectrum</span><span class="p">,</span><span class="n">final_Omg_V_spectrum</span></div>
</div>


<div class="viewcode-block" id="OmegaGW_BBH">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.OmegaGW_BBH">[docs]</a>
<span class="k">class</span> <span class="nc">OmegaGW_BBH</span><span class="p">(</span><span class="n">OmegaGW</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of `OmegaGW`, used to compute energy density due to BBHs under a &quot;Power-Law + Peak&quot; mass model</span>

<span class="sd">    Implements a function `setProbs` to fix the weights used in integrating over the mass grid to compute</span>
<span class="sd">    a population averaged energy spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref_mMin</span><span class="p">,</span><span class="n">ref_mMax</span><span class="p">,</span><span class="n">ref_zs</span><span class="p">,</span><span class="n">Mtots</span><span class="o">=</span><span class="p">[],</span><span class="n">qs</span><span class="o">=</span><span class="p">[],</span><span class="n">gridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">65</span><span class="p">)):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OmegaGW_BBH</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ref_mMin</span><span class="p">,</span><span class="n">ref_mMax</span><span class="p">,</span><span class="n">ref_zs</span><span class="p">,</span><span class="mi">3000</span><span class="p">,</span><span class="n">Mtots</span><span class="o">=</span><span class="n">Mtots</span><span class="p">,</span><span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">,</span><span class="n">gridSize</span><span class="o">=</span><span class="n">gridSize</span><span class="p">)</span>

<div class="viewcode-block" id="OmegaGW_BBH.setProbs_plPeak">
<a class="viewcode-back" href="../gwBackground.html#gwBackground.OmegaGW_BBH.setProbs_plPeak">[docs]</a>
    <span class="k">def</span> <span class="nf">setProbs_plPeak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mMin</span><span class="p">,</span><span class="n">mMax</span><span class="p">,</span><span class="n">dmMin</span><span class="p">,</span><span class="n">dmMax</span><span class="p">,</span><span class="n">lmbda</span><span class="p">,</span><span class="n">mu_peak</span><span class="p">,</span><span class="n">sig_peak</span><span class="p">,</span><span class="n">frac_peak</span><span class="p">,</span><span class="n">bq</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to set mass-dependent weights over precomputed energy-density spectra in order</span>
<span class="sd">        to implement and integrate over a realistic black hole mass distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mMin : float</span>
<span class="sd">            Mass below which the black hole primary mass distribution is truncated to zero</span>
<span class="sd">        mMax : float</span>
<span class="sd">            Mass above which the black hole primary mass distribution is truncated to zero</span>
<span class="sd">        dmMin : float</span>
<span class="sd">            Scale of the exponential truncation applied below `mMin`</span>
<span class="sd">        dmMax : float</span>
<span class="sd">            Scale of the exponential truncation applied above `mMax`</span>
<span class="sd">        lmbda : float</span>
<span class="sd">            Power-law exponent describing the bulk of the primary mass distribution</span>
<span class="sd">        mu_peak : float</span>
<span class="sd">            The location of a Gaussian excess in the primary mass distribution</span>
<span class="sd">        sig_peak : float</span>
<span class="sd">            Standard deviation of the gaussian excess</span>
<span class="sd">        frac_peak : float</span>
<span class="sd">            The mixture fraction between power law and Gaussian components of the primary mass distribution.</span>
<span class="sd">            (Note that the exponential truncations make this mixture fraction only approximate)</span>
<span class="sd">        bq : float</span>
<span class="sd">            Power-law exponent governing mass ratio distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Jacobian with which to convert integration over d(lnM)dq to d(m1)d(m2)</span>
        <span class="n">probs_jacobian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtots_2d</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_2d</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>

        <span class="c1"># Power law component in m1</span>
        <span class="n">p_m1_pl</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">lmbda</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">**</span><span class="n">lmbda</span><span class="o">/</span><span class="p">(</span><span class="mf">100.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">lmbda</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">lmbda</span><span class="p">))</span>

        <span class="c1"># Gaussian component in m1</span>
        <span class="n">p_m1_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">-</span><span class="n">mu_peak</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sig_peak</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sig_peak</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Compute low- and high-mass filters</span>
        <span class="n">low_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">-</span><span class="n">mMin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">dmMin</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">low_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">&lt;</span><span class="n">mMin</span><span class="p">,</span><span class="n">low_filter</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">high_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">-</span><span class="n">mMax</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">dmMax</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">high_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">&gt;</span><span class="n">mMax</span><span class="p">,</span><span class="n">high_filter</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>

        <span class="c1"># Apply filters to combined power-law and peak</span>
        <span class="n">probs_m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_peak</span><span class="o">*</span><span class="n">p_m1_peak</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">frac_peak</span><span class="p">)</span><span class="o">*</span><span class="n">p_m1_pl</span><span class="p">)</span><span class="o">*</span><span class="n">low_filter</span><span class="o">*</span><span class="n">high_filter</span>
        <span class="n">probs_m1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="o">&gt;=</span><span class="mf">100.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Probability on secondary mass</span>
        <span class="n">probs_m2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">bq</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2s_2d</span><span class="p">,</span><span class="n">bq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1s_2d</span><span class="p">,</span><span class="mf">1.</span><span class="o">+</span><span class="n">bq</span><span class="p">)</span><span class="o">-</span><span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">bq</span><span class="p">))</span>  
        <span class="n">probs_m2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m2s_2d</span><span class="o">&lt;=</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Combine and set</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">probs_jacobian</span><span class="o">*</span><span class="n">probs_m1</span><span class="o">*</span><span class="n">probs_m2</span>
        <span class="n">probs</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, T. Callister, L. Jenks, D. Holz, N. Yunes.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>